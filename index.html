<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>AudioLog Dashboard</title>
  <style>
    body { margin:0; font-family:Arial,sans-serif; background:#121212; color:#fff; display:flex; flex-direction:column; align-items:center;}
    header { background:#1DB954; padding:20px; font-size:2em; font-weight:bold; width:100%; text-align:center;}
    .container { max-width:900px; margin:30px auto; padding:20px; background:#1E1E1E; border-radius:15px; box-shadow:0 0 20px rgba(0,0,0,0.5); width:90%; }
    #login { background:#1DB954; color:#fff; border:none; padding:15px 30px; font-size:1.2em; border-radius:25px; cursor:pointer; margin-bottom:30px; }
    #login:hover { background:#1ed760cc; }
    .track { display:flex; align-items:center; margin-bottom:15px; padding:10px; border-radius:10px; transition:0.2s; }
    .track:hover { background:#2a2a2a; }
    .cover { width:64px; height:64px; border-radius:5px; margin-right:15px; }
    .info { display:flex; flex-direction:column; }
    .track-name { font-weight:bold; color:#1DB954; }
    .artist-album { font-size:0.9em; color:#ccc; }
    @media(max-width:600px){ .track{flex-direction:column; align-items:flex-start;} .cover{margin-bottom:10px;} }
  </style>
</head>
<body>
  <header>AudioLog Dashboard</header>
  <div class="container">
    <button id="login">Login con Spotify</button>
    <div id="recent"></div>
  </div>

  <script>
    const loginButton = document.getElementById('login');
    const recentDiv = document.getElementById('recent');

    const vercelLoginUrl = 'https://audiolog-one.vercel.app/login';

    loginButton.addEventListener('click', () => {
      window.location.href = vercelLoginUrl;
    });

    // Leggi token dall'URL hash
    const hash = window.location.hash.substring(1);
    const params = new URLSearchParams(hash);
    const tokenFromUrl = params.get('access_token');

    if(tokenFromUrl){
      localStorage.setItem('spotify_access_token', tokenFromUrl);
      history.replaceState(null,null,'index.html');
    }

    const accessToken = localStorage.getItem('spotify_access_token');

    if(accessToken){
      fetch("https://api.spotify.com/v1/me/player/recently-played?limit=50", {
        headers: { "Authorization": `Bearer ${accessToken}` }
      })
      .then(res=>res.json())
      .then(data=>{
        if(data.items && data.items.length>0){
          recentDiv.innerHTML="";
          data.items.forEach(item=>{
            const track = item.track;
            const div=document.createElement('div');
            div.classList.add('track');

            const cover=document.createElement('img');
            cover.src=track.album.images[0].url;
            cover.classList.add('cover');

            const info=document.createElement('div');
            info.classList.add('info');

            const name=document.createElement('div');
            name.classList.add('track-name');
            name.textContent=track.name;

            const artistAlbum=document.createElement('div');
            artistAlbum.classList.add('artist-album');
            artistAlbum.textContent=`${track.artists.map(a=>a.name).join(", ")} - ${track.album.name}`;

            info.appendChild(name);
            info.appendChild(artistAlbum);

            div.appendChild(cover);
            div.appendChild(info);

            recentDiv.appendChild(div);
          });
        } else recentDiv.innerHTML="<p>Nessun brano trovato.</p>";
      })
      .catch(err=>{ console.error(err); recentDiv.innerHTML="<p>Errore nel recuperare i brani.</p>"; });
    }
  </script>
</body>
</html>
