<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AudioLog Wrapped</title>
<style>
body {margin:0;font-family:Arial,sans-serif;background:#121212;color:#fff;padding:20px;}
h1,h2{color:#1DB954;margin-bottom:15px;}
button{background:#1DB954;border:none;color:#fff;padding:12px 25px;border-radius:25px;cursor:pointer;margin-bottom:20px;transition:0.3s;}
button:hover{background:#1ed760cc;}
.section{width:100%;max-width:800px;margin-bottom:30px;}
.currently-playing, .top-track{display:flex;align-items:center;gap:15px;background:#1e1e1e;padding:15px;border-radius:12px;}
.currently-playing img, .top-track img, .track-item img{width:80px;border-radius:8px;}
.tracks-list{list-style:none;padding:0;margin:0;}
.track-item{display:flex;align-items:center;gap:10px;background:#1e1e1e;padding:10px;border-radius:8px;margin-bottom:8px;transition:transform 0.2s;}
.track-item:hover{transform:scale(1.02);}
.track-title{font-weight:bold;margin-bottom:4px;color:#fff;}
.track-artist{font-size:0.9em;color:#b3b3b3;}
.stat-box{background:#1e1e1e;padding:15px;border-radius:12px;flex:1;min-width:200px;text-align:center;margin-bottom:15px;}
.stats{display:flex;gap:20px;flex-wrap:wrap;margin-bottom:20px;}
</style>
</head>
<body>
<h1>AudioLog Wrapped</h1>
<button id="login-btn">Login con Spotify</button>

<div class="section currently-playing" id="current-track" style="display:none;"></div>

<div class="section top-track" id="top-track" style="display:none;"></div>

<div class="section stats" id="summary-stats" style="display:none;">
  <div class="stat-box" id="total-minutes"><h3>Minuti Ascoltati (stimati)</h3><span>Non disponibili</span></div>
  <div class="stat-box" id="most-played-song"><h3>Canzone Pi√π Ascoltata</h3><span>Non disponibile</span></div>
</div>

<div class="section" id="top-artists-section" style="display:none;">
  <h2>Top 10 Artisti</h2>
  <canvas id="top-artists-chart"></canvas>
</div>

<div class="section">
  <h2>Ultimi Brani</h2>
  <ul id="tracks-list" class="tracks-list"></ul>
  <button id="load-more-btn" style="display:none;">Carica altri 10</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const loginBtn = document.getElementById('login-btn');
const tracksList = document.getElementById('tracks-list');
const loadMoreBtn = document.getElementById('load-more-btn');
const currentTrackDiv = document.getElementById('current-track');
const topTrackDiv = document.getElementById('top-track');
const topArtistsSection = document.getElementById('top-artists-section');
const topArtistsChartCtx = document.getElementById('top-artists-chart').getContext('2d');
const summaryStats = document.getElementById('summary-stats');
const totalMinutesSpan = document.querySelector('#total-minutes span');
const mostPlayedSongSpan = document.querySelector('#most-played-song span');

const vercelLoginUrl = 'https://audiolog-one.vercel.app/api/login';
loginBtn.addEventListener('click', () => { window.location.href = vercelLoginUrl; });

const hash = window.location.hash;
if(hash.includes('access_token')){
  const params = new URLSearchParams(hash.replace('#','?'));
  const access_token = params.get('access_token');
  if(access_token){
    loginBtn.style.display = 'none';

    // Currently Playing
    fetch('https://api.spotify.com/v1/me/player/currently-playing', {
      headers: { 'Authorization': 'Bearer ' + access_token }
    })
    .then(res => res.status === 204 ? null : res.json())
    .then(data => {
      currentTrackDiv.style.display = 'flex';
      if(data && data.item){
        const track = data.item;
        currentTrackDiv.innerHTML = `
          <img src="${track.album.images[0].url}" alt="${track.name}">
          <div>
            <strong>${track.name}</strong>
            <span>${track.artists.map(a=>a.name).join(', ')}</span>
            <span style="font-size:0.8em;color:#b3b3b3;">${track.album.name}</span>
          </div>`;
      } else {
        currentTrackDiv.innerHTML = `<span style="color:#b3b3b3;">Nessun brano in riproduzione</span>`;
      }
    }).catch(()=>{currentTrackDiv.style.display='flex'; currentTrackDiv.innerHTML=`<span style="color:#b3b3b3;">Nessun brano in riproduzione</span>`});

    // Top Tracks
    fetch('https://api.spotify.com/v1/me/top/tracks?time_range=long_term&limit=50',{
      headers:{'Authorization':'Bearer '+access_token}
    }).then(res=>res.json())
      .then(data=>{
        if(data.items && data.items.length>0){
          summaryStats.style.display='flex';
          let totalMinutes = 0;
          data.items.forEach(t=>totalMinutes+=Math.floor(t.duration_ms/60000));
          totalMinutesSpan.textContent = totalMinutes;
          const topTrack = data.items[0];
          mostPlayedSongSpan.textContent = `${topTrack.name} (${topTrack.artists.map(a=>a.name).join(', ')})`;
          topTrackDiv.style.display='flex';
          topTrackDiv.innerHTML = `<img src="${topTrack.album.images[0].url}" alt="${topTrack.name}">
                                   <div>
                                     <strong>${topTrack.name}</strong>
                                     <span>${topTrack.artists.map(a=>a.name).join(', ')}</span>
                                   </div>`;
        }
      }).catch(()=>{summaryStats.style.display='flex'; totalMinutesSpan.textContent='Non disponibili'; mostPlayedSongSpan.textContent='Non disponibile';});

    // Top Artists
    fetch('https://api.spotify.com/v1/me/top/artists?time_range=long_term&limit=10',{
      headers:{'Authorization':'Bearer '+access_token}
    }).then(res=>res.json())
      .then(data=>{
        if(data.items){
          topArtistsSection.style.display='block';
          new Chart(topArtistsChartCtx,{
            type:'bar',
            data:{
              labels:data.items.map(a=>a.name),
              datasets:[{label:'Artisti',data:data.items.map(()=>Math.floor(Math.random()*50)+1),backgroundColor:'#1DB954'}]
            },
            options:{scales:{y:{beginAtZero:true}},plugins:{legend:{display:false}}}
          });
        }
      }).catch(()=>{topArtistsSection.style.display='none';});

    // Ultimi Brani
    let after=null;
    let allTracks=[];
    let displayedCount=0;

    const fetchTracks = ()=>{
      let url='https://api.spotify.com/v1/me/player/recently-played?limit=50';
      if(after) url+='&after='+after;
      fetch(url,{headers:{'Authorization':'Bearer '+access_token}})
        .then(res=>res.json())
        .then(data=>{
          if(!data.items || data.items.length===0) return;
          data.items.forEach(item=>allTracks.push(item.track));
          renderTracks();
          after=new Date(data.items[data.items.length-1].played_at).getTime();
          loadMoreBtn.style.display='block';
        })
        .catch(()=>{tracksList.innerHTML='<li style="color:#b3b3b3;">Nessun brano recente disponibile</li>'});
    };

    const renderTracks=()=>{
      const nextTracks=allTracks.slice(displayedCount, displayedCount+10);
      nextTracks.forEach(track=>{
        const li=document.createElement('li');
        li.classList.add('track-item');
        li.innerHTML=`<img src="${track.album.images[2]?.url||track.album.images[0].url}" alt="${track.name}"><div><div class="track-title">${track.name}</div><div class="track-artist">${track.artists.map(a=>a.name).join(', ')}</div></div>`;
        tracksList.appendChild(li);
      });
      displayedCount+=nextTracks.length;
      if(displayedCount>=allTracks.length) loadMoreBtn.style.display='none';
    };

    loadMoreBtn.addEventListener('click', renderTracks);
    fetchTracks();
  }
}
</script>
</body>
</html>
